name: ğŸ³ Build and Publish Docker Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push-uno:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_NAME: uno

    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=pr,prefix=pr-

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build and push uno
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/uno/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  build-and-push-web:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_NAME: web

    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v5

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=pr,prefix=pr-

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build and push web
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-preview:
    if: github.event_name == 'pull_request'
    needs: [build-and-push-uno, build-and-push-web]
    name: ğŸš€ Deploy PR Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}

      DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
      DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      FEIDE_CLIENT_ID: ${{ secrets.FEIDE_CLIENT_ID }}
      FEIDE_CLIENT_SECRET: ${{ secrets.FEIDE_CLIENT_SECRET }}
      PREVIEW_ADMIN_KEY: ${{ secrets.PREVIEW_ADMIN_KEY }}
      PREVIEW_DOMAIN: ${{ secrets.PREVIEW_DOMAIN }}
      PREVIEW_DATABASE_PASSWORD: ${{ secrets.PREVIEW_DATABASE_PASSWORD }}

    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/scripts

      - name: ğŸš€ Deploy PR Preview to Dokploy
        id: deploy
        run: node .github/scripts/dokploy-preview.mjs deploy

      - name: ğŸ’¬ Comment on PR
        if: steps.deploy.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const marker = '<!-- dokploy-preview -->';
            const body = [
              marker,
              '## Preview Environment',
              '',
              '| Service | URL |',
              '|---------|-----|',
              `| Frontend | ${{ steps.deploy.outputs.web_url }} |`,
              `| Backend | ${{ steps.deploy.outputs.api_url }} |`,
              '',
              `_Deployed from \`${context.sha.slice(0, 7)}\`_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
            });
            const existing = comments.find((c) => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body,
              });
            }
